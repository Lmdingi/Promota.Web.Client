@page "/promote"
@attribute [Authorize]
@rendermode InteractiveServer
@inject NavigationManager _navigationManager

<div class="card shadow-lg mb-4 border-0 rounded-4" style="height: 650px; overflow: hidden;">
   
    <div class="card-footer bg-white border-top-0 px-4 pt-3 h-100 d-flex flex-column">
        
        <!-- Tabs -->
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link @((activeTab == "promote") ? "active" : "")" @onclick="@(() => SetActiveTab("promote"))">Promote</a>
            </li>

            <li class="nav-item">
                <a class="nav-link @((activeTab == "events") ? "active" : "")" @onclick="@(() => SetActiveTab("events"))">Events</a>
            </li>

            <li class="nav-item">
                <a class="nav-link @((activeTab == "analytics") ? "active" : "")" @onclick="@(() => SetActiveTab("analytics"))">Analytics</a>
            </li>

            <li class="nav-item">
                <a class="nav-link @((activeTab == "going") ? "active" : "")" @onclick="@(() => SetActiveTab("going"))">Going</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="p-3 border rounded-bottom rounded-end flex-grow-1 overflow-auto">
            @if (activeTab == "promote")
            {
                <CreateEventForm OnAlertChanged="HandleAlertChanged"></CreateEventForm>
            }
            else if (activeTab == "events")
            {
                <MyEvents OnEdit="SetActiveTab"></MyEvents>
            }
            else if (activeTab == "analytics")
            {
                <p><strong>Analytics:</strong> Track attendance, views, engagement, and ratings per event. (future).</p>
            }
            else if (activeTab == "going")
            {
                <p><strong>Going:</strong> List of events the user marked to attend. (future).</p>
            }
        </div>
    </div>
</div>

@if (Alert != null)
{
    <AlertModal Alert="@Alert" OnAlertChanged="HandleAlertChanged"></AlertModal>
}

@code {
    public Alert? Alert { get; set; }
    private string activeTab = "promote";

    private void SetActiveTab(string tab)
    {
        if (tab != "promote")
        {
            var uri = _navigationManager.ToAbsoluteUri(_navigationManager.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);

            if (query.TryGetValue("eventId", out var eventId))
            {
                _navigationManager.NavigateTo("/promote", forceLoad: false, replace: true);
            }
        }

        if (activeTab == tab)
        {
            activeTab = "";
        }
        else
        {
            activeTab = tab;
        }
    }

    private async Task HandleAlertChanged(Alert? alert)
    {
        Alert = alert;
        StateHasChanged();

        if (alert != null && alert.Type == AlertType.Success)
        {
            activeTab = "events";
            await Task.Delay(3000);
            Alert = null;
            StateHasChanged();
        }
    }
}
